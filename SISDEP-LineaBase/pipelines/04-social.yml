# Pipeline para módulo de Social
# Ejecuta las pruebas del módulo social (venteros, vehículos, ofertas, estudios)

trigger:
  branches:
    include:
      - LineaBase
      - main
      - master
  paths:
    include:
      - SISDEP-LineaBase/tests/features/social/*
      - SISDEP-LineaBase/page_objects/venteros_page.py
      - SISDEP-LineaBase/page_objects/vehiculos_page.py
      - SISDEP-LineaBase/page_objects/ofertas_institucionales_page.py
      - SISDEP-LineaBase/page_objects/estudio_socioeconomico_page.py
      - SISDEP-LineaBase/pipelines/04-social.yml

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'
  moduleName: 'social'
  reportPath: '$(System.DefaultWorkingDirectory)/SISDEP-LineaBase/reports/$(moduleName)'

stages:
- stage: TestSocial
  displayName: 'Ejecutar Pruebas - Social'
  jobs:
  - job: RunTests
    displayName: 'Ejecutar Tests de Social'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
      displayName: 'Configurar Python $(pythonVersion)'

    - script: |
        python -m pip install --upgrade pip
        pip install -r SISDEP-LineaBase/requirements.txt
      displayName: 'Instalar dependencias'

    - script: |
        playwright install chromium
        playwright install-deps chromium
      displayName: 'Instalar Playwright y navegadores'

    - script: |
        cd SISDEP-LineaBase
        mkdir -p reports/$(moduleName)
        pytest tests/features/social/ \
          -v \
          -m "social" \
          --html=reports/$(moduleName)/report.html \
          --self-contained-html \
          --junitxml=reports/$(moduleName)/junit.xml
      displayName: 'Ejecutar pruebas de Social'
      continueOnError: true

    - task: PublishTestResults@2
      inputs:
        testResultsFiles: '**/junit.xml'
        testRunTitle: 'Pruebas de Social'
        failTaskOnFailedTests: false
      displayName: 'Publicar resultados de pruebas'

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(System.DefaultWorkingDirectory)/SISDEP-LineaBase/reports/$(moduleName)'
        artifactName: 'Reporte-Social'
        publishLocation: 'Container'
      displayName: 'Publicar reporte HTML'

