# Define el trigger, se ejecutará en cada push a la rama 'pruebas funcionales'
trigger:
- 'pruebas-funcionales'

# Usa un agente de Linux, necesario para construir la imagen de Docker
pool:
  name: 'DANIELP'

stages:
- stage: BuildAndTest
  displayName: 'Build and Run Robot Tests'
  jobs:
  - job: RobotFrameworkJob
    displayName: 'Robot Framework CI Job'
    steps:

    # --- CAMBIO IMPORTANTE ---
    # Se reemplaza la tarea DockerCompose@0 por CmdLine@2 para usar Compose V2
    - task: CmdLine@2
      displayName: 'Build Docker Image (Compose V2)'
      inputs:
        script: 'docker compose --profile ci build'

    # --- CAMBIO IMPORTANTE ---
    # Se reemplaza la tarea DockerCompose@0 por CmdLine@2 para usar Compose V2
    - task: CmdLine@2
      displayName: 'Run Robot Tests (Compose V2)'
      inputs:
        script: 'docker compose --profile ci up --abort-on-container-exit'

    # Este paso no cambia: publica los resultados para verlos en la pestaña "Tests"
    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      condition: succeededOrFailed()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/output.xml'
        searchFolder: '$(System.DefaultWorkingDirectory)/reports'
        failTaskOnFailedTests: true

    # Este paso no cambia: publica los reportes HTML como un archivo descargable
    - task: PublishPipelineArtifact@1
      displayName: 'Publish HTML Reports'
      condition: succeededOrFailed()
      inputs:
        targetPath: 'reports'
        artifactName: 'Robot Test Reports'

