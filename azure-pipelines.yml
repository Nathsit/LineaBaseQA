# Define el trigger, se ejecutar√° en cada push a la rama 'pruebas funcionales'
trigger:
  branches:
    include:
      - pruebas-funcionales

# Usa tu agente personalizado
pool:
  name: 'DANIELP'

stages:
  - stage: BuildAndTest
    displayName: 'Build and Run Robot Tests'
    jobs:
      - job: RobotFrameworkJob
        displayName: 'Robot Framework CI Job'
        steps:

        # Paso 1: Ejecutar los tests usando la imagen de Docker Hub con Docker Compose V2
        - script: |
            docker compose --profile dockerhub-ci up --abort-on-container-exit
          displayName: 'Run Robot Tests with Docker Hub Image'
          workingDirectory: '$(System.DefaultWorkingDirectory)'
          runAsAdmin: true

        # Paso 2: Publicar los resultados de las pruebas en Azure DevOps
        - task: PublishTestResults@2
          displayName: 'Publish Test Results'
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/output.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)/reports'
            failTaskOnFailedTests: true

        # Paso 3: Publicar los reportes HTML como un artefacto
        - task: PublishPipelineArtifact@1
          displayName: 'Publish HTML Reports'
          condition: succeededOrFailed()
          inputs:
            targetPath: 'reports'
            artifactName: 'Robot Test Reports' 