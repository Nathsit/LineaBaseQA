# Define el trigger, se ejecutarÃ¡ en cada push a la rama 'pruebas funcionales'
trigger:
  branches:
    include:
      - pruebas-funcionales
pool:
  vmImage: 'ubuntu-latest'

steps:
- task: Docker@2
  inputs:
    containerRegistry: 'Docker Hub'
    repository: 'your-dockerhub-username/sisdep-robot-tests'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: |
      latest
      $(Build.BuildId)
  displayName: 'Build and push Docker image'

- script: |
    docker run --rm \
      -v $(Build.ArtifactStagingDirectory)/reports:/app/reports \
      -e DISPLAY=:99 \
      -e CHROME_BIN=/usr/bin/google-chrome \
      -e CHROMEDRIVER_PATH=/usr/local/bin/chromedriver \
      your-dockerhub-username/sisdep-robot-tests:$(Build.BuildId) \
      sh -c "Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 & robot --outputdir reports test_suites/features/"
  displayName: 'Ejecutar pruebas Robot Framework en Docker'

- task: PublishTestResults@2
  condition: succeededOrFailed()
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '$(Build.ArtifactStagingDirectory)/reports/output.xml'
    failTaskOnFailedTests: true

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/reports'
    ArtifactName: 'RobotReports'
    publishLocation: 'Container' 