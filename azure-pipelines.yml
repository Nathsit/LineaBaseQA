# Define el trigger, se ejecutar√° en cada push a la rama 'pruebas funcionales'
trigger:
- 'pruebas-funcionales'

# Usa un agente de Linux, necesario para ejecutar la imagen de Docker
pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: BuildAndTest
  displayName: 'Build and Run Robot Tests'
  jobs:
  - job: RobotFrameworkJob
    displayName: 'Robot Framework CI Job'
    steps:

    # Paso 1: Login al Azure Container Registry
    - task: AzureCLI@2
      displayName: 'Login to Azure Container Registry'
      inputs:
        azureSubscription: 'Azure subscription 1'
        scriptType: 'pscore'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az acr login --name sisdepregistry

    # Paso 2: Ejecutar los tests usando la imagen del ACR
    - task: DockerCompose@0
      displayName: 'Run Robot Tests with ACR Image'
      inputs:
        containerregistrytype: 'Container Registry'
        dockerComposeFile: 'docker-compose.yml'
        action: 'Run a Docker Compose command'
        dockerComposeCommand: '--profile acr-ci up --abort-on-container-exit'

    # Paso 3: Publicar los resultados de las pruebas en Azure DevOps
    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      condition: succeededOrFailed()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/output.xml'
        searchFolder: '$(System.DefaultWorkingDirectory)/reports'
        failTaskOnFailedTests: true

    # Paso 4: Publicar los reportes HTML como un artefacto
    - task: PublishPipelineArtifact@1
      displayName: 'Publish HTML Reports'
      condition: succeededOrFailed()
      inputs:
        targetPath: 'reports'
        artifactName: 'Robot Test Reports'